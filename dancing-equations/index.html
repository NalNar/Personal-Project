<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Dancing Equations — Audio Reactive (Minimal Canvas)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- MathJax (SVG output) -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<!-- YouTube IFrame API (optional player) -->
<script src="https://www.youtube.com/iframe_api"></script>
<style>
  html,body{height:100%;margin:0;background:#0a0f24;color:#e8edff;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .ui{position:fixed;left:12px;top:12px;right:12px;display:flex;gap:8px;flex-wrap:wrap;z-index:3}
  .ui input,.ui button{border:1px solid #314177;background:#0f1636;color:#e8edff;border-radius:10px;padding:9px 12px}
  .ui input{flex:1}
  .ui .btn{cursor:pointer}
  #msg{position:fixed;left:12px;bottom:12px;color:#a8b3d6;font-size:12px}
  canvas{position:fixed;inset:0}
</style>
</head>
<body>
  <div class="ui">
    <input id="yt" placeholder="YouTube URL (optional) — load & then Start Tab Audio"/>
    <button id="load" class="btn">Load</button>
    <button id="tab"  class="btn">Start Tab Audio</button>
    <button id="mic"  class="btn">Use Microphone</button>
    <button id="hue"  class="btn">New Hue</button>
  </div>
  <div id="msg">Tip: If you only see plain “e^{iπ}+1=0”, you’re on the wrong file. This version draws on <b>canvas</b> and always animates.</div>
  <div id="player" style="position:fixed;right:12px;bottom:12px;width:340px;max-width:45vw;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden;z-index:2"></div>
  <canvas id="bg"></canvas>
  <canvas id="main"></canvas>

<script>
/* ===== helpers ===== */
const $ = s=>document.querySelector(s);
const rand=(a,b)=>a+Math.random()*(b-a);

/* ===== YouTube (optional) ===== */
let ytPlayer=null;
function parseVideoId(url){
  try{const u=new URL(url);
    if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    const m=url.match(/\/embed\/([a-zA-Z0-9_-]{6,})/); return m?m[1]:null;
  }catch{ return null; }
}
window.onYouTubeIframeAPIReady = () => {
  ytPlayer = new YT.Player('player', { videoId:'dQw4w9WgXcQ', playerVars:{playsinline:1,rel:0,modestbranding:1,controls:1} });
};
$('#load').onclick = ()=>{
  const id = parseVideoId($('#yt').value.trim());
  if(id) ytPlayer?.loadVideoById(id);
};

/* ===== Audio capture + beat detection ===== */
let audioCtx, analyser, srcNode, rafId=null, prevMag=null, fluxHist=[], lastOnset=0;
function stopAudio(){
  if(rafId) cancelAnimationFrame(rafId), rafId=null;
  if(srcNode?.mediaStream) srcNode.mediaStream.getTracks().forEach(t=>t.stop());
  if(audioCtx) audioCtx.close();
  audioCtx=analyser=srcNode=null; prevMag=null; fluxHist=[]; lastOnset=0;
}
async function startWithTab(){
  stopAudio();
  const stream = await navigator.mediaDevices.getDisplayMedia({ video:{frameRate:1}, audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false} });
  initAudio(stream);
}
async function startWithMic(){
  stopAudio();
  const stream = await navigator.mediaDevices.getUserMedia({ audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false} });
  initAudio(stream);
}
function initAudio(stream){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  srcNode  = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048; analyser.smoothingTimeConstant = 0.5;
  srcNode.connect(analyser);
  processAudio();
}
function processAudio(){
  const N = analyser.frequencyBinCount;
  const f = new Float32Array(N); analyser.getFloatFrequencyData(f);
  const mag = new Float32Array(N); for(let i=0;i<N;i++) mag[i] = Math.pow(10, f[i]/20);
  if(!prevMag) prevMag = mag;
  let flux=0; for(let i=0;i<N;i++){ const d=mag[i]-prevMag[i]; if(d>0) flux+=d; } prevMag=mag;
  const W=45; fluxHist.push(flux); if(fluxHist.length>120) fluxHist.shift();
  const M=Math.min(W,fluxHist.length);
  let mean=0, sq=0; for(let i=fluxHist.length-M;i<fluxHist.length;i++) mean+=fluxHist[i]; mean/=M;
  for(let i=fluxHist.length-M;i<fluxHist.length;i++){ const v=fluxHist[i]-mean; sq+=v*v; }
  const std=Math.sqrt(sq/M), thresh=mean+1.6*std; // sensitivity
  const now=performance.now();
  if(flux>thresh && (now-lastOnset)>120){ lastOnset=now; beat(); }
  rafId=requestAnimationFrame(processAudio);
}
$('#tab').onclick = async ()=>{ try{ await startWithTab(); $('#msg').textContent='Tab audio running (make sure “Share tab audio” was enabled).'; }catch(e){ $('#msg').textContent='Tab audio blocked. On Chrome pick “Chrome Tab → This tab” and enable “Share tab audio”.'; } };
$('#mic').onclick = async ()=>{ try{ await startWithMic(); $('#msg').textContent='Mic capture running (turn speakers up a bit).'; }catch(e){ $('#msg').textContent='Mic permission denied.'; } };

/* ===== Math → SVG → Image ===== */
const equations = [
  String.raw`e^{i\pi}+1=0`,
  String.raw`\int_{-\infty}^{\infty} e^{-x^2}\,dx=\sqrt{\pi}`,
  String.raw`a^2+b^2=c^2`,
  String.raw`E=mc^2`,
  String.raw`\sum_{n=1}^{\infty}\frac{1}{n^2}=\frac{\pi^2}{6}`,
  String.raw`\nabla\cdot\vec{E}=\rho/\varepsilon_0`
];
async function texToImg(tex, color='#e8edff'){
  await MathJax.startup.promise;              // ensure MathJax ready
  const node = MathJax.tex2svg(tex,{display:true});
  const svg  = node.querySelector('svg');
  svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
  svg.setAttribute('fill', color);
  const str = new XMLSerializer().serializeToString(svg);
  const url = URL.createObjectURL(new Blob([str],{type:'image/svg+xml'}));
  const img = new Image(); img.onload=()=>URL.revokeObjectURL(url); img.src=url;
  await img.decode?.().catch(()=>{}); return img;
}

/* ===== Canvas scene (always moving) ===== */
const bg = $('#bg'), main = $('#main');
const bctx = bg.getContext('2d'), ctx = main.getContext('2d');
let W=0,H=0, sprites=[], hue=260;
function resize(){
  const dpr=Math.max(1,window.devicePixelRatio||1);
  [bg,main].forEach(c=>{ c.width=innerWidth*dpr; c.height=innerHeight*dpr; c.style.width='100%';c.style.height='100%'; c.getContext('2d').setTransform(dpr,0,0,dpr,0,0); });
  W=innerWidth; H=innerHeight;
}
addEventListener('resize', resize); resize();

function drawStars(){
  bctx.clearRect(0,0,W,H);
  for(let i=0;i<240;i++){
    const x=(i*97)%W, y=(i*57)%H, z=(i%5)/5+0.2, r=(i%3)+0.5;
    const a = (Math.sin(performance.now()*0.001 + i)*0.5+0.5)*0.7+0.1;
    bctx.fillStyle=`hsla(${hue},100%,80%,${a*0.6})`;
    bctx.beginPath(); bctx.arc(x,y,r*z,0,Math.PI*2); bctx.fill();
  }
}

function randomSprite(img){
  const r = Math.min(W,H)*rand(0.18,0.42);
  return { img, w: img.width*0.65, h: img.height*0.65,
           r, a: rand(0,Math.PI*2), spd: rand(-0.6,0.6), rot: rand(-0.2,0.2),
           bob: rand(0.6,1.6), scale: rand(0.6,1.1), kick:0 };
}

async function buildSprites(){
  const color=`hsl(${hue},100%,88%)`;
  const imgs = await Promise.all(equations.map(t=>texToImg(t,color)));
  sprites = [];
  for(let i=0;i<12;i++) sprites.push( randomSprite(imgs[i % imgs.length]) );
}
buildSprites();

let last=performance.now();
function tick(){
  drawStars();
  const now=performance.now(), dt=Math.min(0.05,(now-last)/1000); last=now;
  const cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.globalCompositeOperation='lighter';
  for(const s of sprites){
    s.a += s.spd * dt * 0.45;
    const x = cx + Math.cos(s.a)*s.r;
    const y = cy + Math.sin(s.a)*s.r*0.7 + Math.sin(now*0.001*s.bob)*6;
    s.kick *= Math.pow(0.001, dt);            // decay energy
    const k = 1 + 0.25*s.kick;
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(s.rot + Math.sin(now*0.0007 + s.r*0.001)*0.08);
    ctx.scale(k*s.scale, k*s.scale);
    ctx.shadowColor=`hsla(${hue},100%,70%,.65)`; ctx.shadowBlur=18;
    ctx.drawImage(s.img, -s.w/2, -s.h/2, s.w, s.h);
    ctx.restore();
  }
  ctx.restore();
  requestAnimationFrame(tick);
}
tick();

/* ===== Beat visual ===== */
function beat(){
  for(const s of sprites){ s.kick = Math.min(1, s.kick + 1); }
  hue = Math.floor(rand(0,360));
}
$('#hue').onclick = ()=>{ hue=Math.floor(rand(0,360)); buildSprites(); };

/* ===== Wire buttons ===== */
document.addEventListener('keydown', e=>{ if(e.key===' ') beat(); });
</script>
</body>
</html>
